(()=>{async function t(t){try{const e={text:t&&(t.text||t.message||t.query||"")};t&&t.sessionId&&(e.sessionId=t.sessionId);const n=await fetch("https://sage.sumvec.com/n8n/webhook/54d7b928-24cf-40a5-b7dc-21ca07900d9a",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic dGVzdDpzdW12ZWM="},body:JSON.stringify(e)});if(!n.ok){const t=await n.text().catch(()=>"<no-body>");return console.warn("Webhook HTTP error",n.status,t),null}let s=await n.json().catch(()=>null);if(!s)return console.warn("Webhook returned empty response"),null;console.log("üîÑ Raw webhook response:",s),Array.isArray(s)&&s.length>0&&(console.log("üìå Response is array, using first element"),s=s[0]);let a=s.output;if("string"==typeof a)try{let t=a.match(/\{[\s\S]*\}/);t?(a=JSON.parse(t[0]),console.log("üì¶ Extracted and parsed JSON from output string:",a)):console.log("‚ÑπÔ∏è Output is plain text (no JSON found):",a.substring(0,100))}catch(t){console.warn("‚ö†Ô∏è Failed to parse output field:",t.message)}let r=[];return Array.isArray(s.products)?r=s.products:Array.isArray(s.results)?r=s.results:s.results&&Array.isArray(s.results.results)?r=s.results.results:s.data&&Array.isArray(s.data.products)?r=s.data.products:Array.isArray(a?.products)?r=a.products:Array.isArray(a)&&"object"==typeof a[0]&&(a[0].id||a[0].title)&&(r=a),r.length>0&&console.log("‚úì Found",r.length,"products"),Object.assign({},s||{},{products:r,parsedOutput:a})}catch(t){return console.warn("Webhook call failed",t),null}}class e{constructor(){this.styleConfig=this._loadStyleConfig(),this.apiBaseUrl=window.ChatBubbleConfig&&window.ChatBubbleConfig.apiUrl||window.location.origin,this.sessionId=this._loadOrGenerateSessionId(),this.isOpen=!1,this.isLoading=!1,this.storeDomain=null,this._ensureStyles(),this._ensureMarkup(),this._bindElements(),this._attachListeners(),this.loadChatHistory(),this.loadStoreDomain(),this._fetchAndApplyStyleConfig()}_loadStyleConfig(){try{try{const t={primaryColor:"#667eea",secondaryColor:"#764ba2",textColor:"#333",textColorLight:"#6b7280",backgroundColor:"#ffffff",backgroundColorLight:"#f8fafc",borderColor:"#e1e5e9",userMessageBg:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",userMessageColor:"#ffffff",assistantMessageBg:"#ffffff",assistantMessageColor:"#333",inputBackground:"#f3f4f6",borderRadius:"18px",borderRadiusSmall:"6px",fontSize:"14px",fontSizeLarge:"18px",fontSizeSmall:"12px",padding:"20px",paddingSmall:"12px",chatBubbleSize:"60px",chatBubbleBorderRadius:"50%",headerBackground:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",headerColor:"#ffffff",headerPadding:"20px",messageRadius:"18px",messagePadding:"12px 16px",messageBorderWidth:"1px",inputBorderRadius:"26px",inputPadding:"12px 18px",inputFontSize:"15px",buttonRadius:"50%",buttonSize:"40px",shadowSmall:"0 2px 6px rgba(16, 24, 40, 0.03)",shadowMedium:"0 4px 20px rgba(102, 126, 234, 0.4)",shadowLarge:"0 10px 40px rgba(0, 0, 0, 0.15)",transitionSpeed:"0.3s"};return localStorage.setItem("cb_style_config",JSON.stringify(t)),t}catch(t){console.warn("Failed to use build-time STYLE_CONFIG:",t)}const t=localStorage.getItem("cb_style_config");if(t)return JSON.parse(t)}catch(t){console.warn("Failed to load style config from localStorage or STYLE_CONFIG:",t)}return{borderColor:"#e1e5e9",borderRadius:"18px",fontSize:"14px",color:"#333"}}async _fetchAndApplyStyleConfig(){try{const t=await fetch("/style-config.json");if(t.ok){const e=await t.json();localStorage.setItem("cb_style_config",JSON.stringify(e)),this.styleConfig=e,console.log("‚úì Loaded custom style config:",e)}}catch(t){console.debug("Style config endpoint not available (using defaults):",t.message)}}_ensureStyles(){if(document.querySelector("style[data-cb-styles]"))return;const t=document.createElement("style");t.setAttribute("data-cb-styles","true"),t.textContent="\n/* Reset and Base Styles */\n* { margin: 0; padding: 0; box-sizing: border-box; }\nbody { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; line-height: 1.6; color: #333; }\n/* Chat Bubble Container */\n.chat-bubble { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: inherit; pointer-events: auto; }\n/* Chat Toggle Button */\n.chat-toggle { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; cursor: pointer; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; z-index: 10000;position: absolute; bottom: 4px; right: 10px; }\n.chat-toggle:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }\n.chat-toggle:active { transform: scale(0.95); }\n/* Chat Window */\n.chat-window {  position: relative; bottom: 75px; right: 24px; width: 380px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e1e5e9; opacity: 1; transform: translateY(0) scale(1); transition: all 0.3s ease; }\n.chat-window.hidden { opacity: 0; transform: translateY(20px) scale(0.9); pointer-events: none; }\n/* Chat Header */\n.chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }\n.chat-title h3 { font-size: 18px; font-weight: 600;color: white; }\n.status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; margin-left: 8px; animation: pulse 2s infinite; }\n@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n.chat-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }\n.chat-close:hover { background-color: rgba(255, 255, 255, 0.2); }\n/* Messages */\n.chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; gap: 8px; display: flex !important; flex-direction: column; }\n.chat-messages::-webkit-scrollbar { width: 8px; }\n.chat-messages::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 8px; }\n.chat-messages::-webkit-scrollbar-track { background: transparent; }\n.message { margin-bottom: 0; display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; }\n.message.user { align-items: flex-end; }\n.message.assistant { align-items: flex-start; }\n.message-content { max-width: 100%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }\n.message.user .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }\n.message.assistant .message-content { background: white; color: #333; border: 1px solid #e1e5e9; border-bottom-left-radius: 4px; }\n.message-time { font-size: 11px; color: #6b7280; margin-top: 4px; padding: 0 8px; }\n@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n/* Input */\n.chat-input-container { padding: 18px 20px; background: white; border-top: 1px solid #f0f0f0; flex-shrink: 0; }\n.input-wrapper { display: flex; align-items: center; gap: 10px; background: #f3f4f6; border-radius: 26px; padding: 12px 18px; border: 1px solid #e5e7eb; transition: all 0.2s ease; }\n.input-wrapper:focus-within { border-color: #667eea; background: #fff; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }\n#chatInput { flex: 1; border: none; background: none; outline: none; font-size: 15px; color: #1f2937; padding: 0; resize: none; width: 100%; min-height: 38px; font-family: inherit; }\n#chatInput::placeholder { color: #6b7280; font-weight: 500; }\n.send-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; width: 40px; height: 40px; min-width: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }\n.send-button:hover { transform: scale(1.08); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }\n.send-button:active { transform: scale(0.95); }\n.send-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }\n.send-button svg { width: 20px; height: 20px; }\n/* Spinner */\n.loading-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; }\n.loading-spinner.hidden { display: none; }\n.spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }\n@keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }\n/* Typing Indicator */\n.typing-indicator { display: flex; align-items: center; padding: 12px 16px; background: white; border: 1px solid #e1e5e9; border-radius: 18px; border-bottom-left-radius: 4px; max-width: 80px; }\n.typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background: #667eea; margin: 0 2px; animation: typing 1.4s infinite ease-in-out; }\n.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }\n.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }\n@keyframes typing { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }\n/* Product card */\n.cb-product { display: flex; gap: 12px; align-items: flex-start; padding: 10px; border-radius: 10px; background: #ffffff; border: 1px solid #eef2f7; box-shadow: 0 2px 6px rgba(16, 24, 40, 0.03); margin-bottom: 10px; }\n.cb-product img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; flex: 0 0 64px; }\n.cb-product > div { display: flex; flex-direction: column; min-width: 0; }\n.cb-product .cb-title { font-weight: 600; color: #111827; line-height: 1.1; }\n.cb-product .cb-actions { margin-top: 8px; display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; width: 100%; }\n.cb-product .cb-price { color: #374151; font-weight: 600; font-size: 13px; }\n.cb-add { \n  transition: all 0.2s ease;\n  flex-shrink: 0;\n}\n.cb-add:hover { \n  transform: translateY(-2px);\n  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n}\n.cb-add:active { \n  transform: translateY(0);\n  opacity: 0.9;\n}\n/* Header layout */\n.chat-header .chat-title { display: flex; align-items: center; gap: 8px; }\n/* Responsive */\n@media (max-width: 480px) {\n  .chat-window { left: 12px; right: 12px; bottom: 80px; width: auto; height: 72vh; border-radius: 12px; }\n  .chat-bubble { bottom: 12px; right: 12px; }\n}\n/* Compatibility */\n.chat-product-card { display: flex; gap: 10px; align-items: flex-start; padding: 8px; border-radius: 10px; background: #fff; border: 1px solid #eef2f7; margin-bottom: 8px; }\n.chat-product-card img { width: 72px; height: 72px; object-fit: cover; border-radius: 8px; flex: 0 0 72px; }\n.chat-product-card .chat-card-body { display: flex; flex-direction: column; min-width: 0; }\n.chat-product-card a { color: var(--cb-primary, #667eea); text-decoration: none; }\n    ";const{primaryColor:e="#667eea",secondaryColor:n="#764ba2",textColor:s="#333",textColorLight:a="#6b7280",backgroundColor:r="#ffffff",backgroundColorLight:o="#f8fafc",borderColor:i="#e1e5e9",userMessageBg:d="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",userMessageColor:c="#ffffff",assistantMessageBg:l="#ffffff",assistantMessageColor:p="#333",inputBackground:g="#f3f4f6",borderRadius:h="18px",borderRadiusSmall:u="6px",fontSize:b="14px",fontSizeLarge:m="18px",fontSizeSmall:f="12px",padding:x="20px",paddingSmall:y="12px",chatBubbleSize:w="60px",chatBubbleBorderRadius:$="50%",headerBackground:v="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",headerColor:C="#ffffff",headerPadding:k="20px",messageRadius:S="18px",messagePadding:I="12px 16px",messageBorderWidth:M="1px",inputBorderRadius:T="26px",inputPadding:_="12px 18px",inputFontSize:B="15px",buttonRadius:L="50%",buttonSize:A="40px",shadowSmall:O="0 2px 6px rgba(16, 24, 40, 0.03)",shadowMedium:z="0 4px 20px rgba(102, 126, 234, 0.4)",shadowLarge:P="0 10px 40px rgba(0, 0, 0, 0.15)",transitionSpeed:H="0.3s"}=this.styleConfig,E=`\n/* Custom Configuration Overrides - Applied Everywhere */\n:root {\n  --cb-primary: ${e};\n  --cb-secondary: ${n};\n  --cb-text: ${s};\n  --cb-text-light: ${a};\n  --cb-bg: ${r};\n  --cb-bg-light: ${o};\n  --cb-border: ${i};\n  --cb-shadow-sm: ${O};\n  --cb-shadow-md: ${z};\n  --cb-shadow-lg: ${P};\n  --cb-radius: ${h};\n  --cb-radius-sm: ${u};\n  --cb-transition: ${H};\n}\n\n/* Chat Bubble Toggle */\n.chat-toggle { \n  width: ${w}; \n  height: ${w}; \n  border-radius: ${$};\n  background: linear-gradient(135deg, ${e} 0%, ${n} 100%); \n  box-shadow: ${z};\n  transition: all ${H} ease;\n}\n.chat-toggle:hover { box-shadow: ${P}; }\n\n/* Chat Header */\n.chat-header { \n  background: ${v}; \n  color: ${C};\n  padding: ${k};\n}\n.chat-title h3 { font-size: ${m}; color: ${C}; }\n\n/* Chat Window */\n.chat-window {\n  background: ${r};\n  border: ${M} solid ${i};\n  border-radius: ${h};\n  box-shadow: ${P};\n  transition: all ${H} ease;\n}\n.chat-window.hidden { transition: all ${H} ease; }\n\n/* Messages Area */\n.chat-messages { \n  background: ${o};\n  padding: ${x};\n}\n\n.message-content { \n  font-size: ${b};\n  border-radius: ${S};\n  padding: ${I};\n  border: ${M} solid transparent;\n}\n\n.message.user .message-content { \n  background: ${d}; \n  color: ${c};\n  border-color: transparent;\n}\n\n.message.assistant .message-content { \n  background: ${l}; \n  color: ${p};\n  border-color: ${i};\n}\n\n.message-time { \n  color: ${a}; \n  font-size: ${f};\n}\n\n/* Input Area */\n.chat-input-container { \n  padding: ${x};\n  background: ${r};\n  border-top: ${M} solid ${i};\n}\n\n.input-wrapper { \n  background: ${g};\n  border-radius: ${T};\n  padding: ${_};\n  border: ${M} solid ${i};\n  transition: all ${H} ease;\n}\n\n.input-wrapper:focus-within { \n  border-color: ${e};\n  background: ${r};\n  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);\n}\n\n#chatInput { \n  font-size: ${B};\n  color: ${s};\n}\n\n#chatInput::placeholder { \n  color: ${a};\n}\n\n/* Send Button */\n.send-button { \n  background: linear-gradient(135deg, ${e} 0%, ${n} 100%);\n  width: ${A};\n  height: ${A};\n  border-radius: ${L};\n  box-shadow: ${z};\n  transition: all ${H} ease;\n  color: white;\n}\n\n.send-button:hover { \n  transform: scale(1.08);\n  box-shadow: ${P};\n}\n\n/* Buttons and Links */\n.cb-add {\n  // background: ${g};\n  background: unset !important;\n  color: ${e};\n  border: ${M} solid ${i};\n  border-radius: ${u};\n  padding: ${y} ${x};\n  font-size: ${f};\n  transition: all ${H} ease;\n  cursor: pointer;\n}\n\n.cb-add:hover { \n  transform: translateY(-2px);\n  box-shadow: ${z};\n  border-color: ${e};\n}\n\n/* Product Cards */\n.cb-product { \n  border: ${M} solid ${i};\n  border-radius: ${u};\n  background: ${r};\n  box-shadow: ${O};\n  margin-bottom: ${y};\n}\n\n.cb-product img { \n  border-radius: ${u};\n}\n\n.cb-product .cb-title { \n  color: ${s};\n  font-size: ${b};\n  font-weight: 600;\n}\n\n.cb-product .cb-price { \n  color: ${a};\n  font-size: ${f};\n}\n\n.cb-product .cb-actions { \n  gap: ${y};\n}\n\n.cb-product a {\n  color: ${e};\n  // background: ${g};\n  // border: ${M} solid ${i};\n  // border-radius: ${u};\n  padding: 2px 6px;\n  transition: all ${H} ease;\n}\n\n.cb-product a:hover {\n  border-color: ${e};\n  transform: translateY(-2px);\n}\n\n/* Close Button */\n.chat-close { \n  color: ${C};\n  font-size: ${m};\n  transition: all ${H} ease;\n}\n\n.chat-close:hover { \n  background-color: rgba(255, 255, 255, 0.2);\n}\n\n/* Typing Indicator */\n.typing-indicator { \n  background: ${r};\n  border: ${M} solid ${i};\n  border-radius: ${S};\n  padding: ${I};\n}\n\n.typing-indicator span { \n  background: ${e};\n  width: 8px;\n  height: 8px;\n}\n\n/* Status Indicator */\n.status-indicator { \n  background: #4ade80;\n}\n\n/* Spinner */\n.spinner {\n  border-top-color: ${e};\n}\n\n/* Product Card Legacy */\n.chat-product-card { \n  border: ${M} solid ${i};\n  background: ${r};\n  border-radius: ${u};\n}\n\n.chat-product-card a { \n  color: ${e};\n  text-decoration: none;\n}\n    `;t.textContent+=E,document.head.appendChild(t)}_loadOrGenerateSessionId(){try{const t="cb_session_id",e="undefined"!=typeof sessionStorage?sessionStorage.getItem(t):null;if(e)return e;let n;return n="undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?"session_"+crypto.randomUUID():"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),"undefined"!=typeof sessionStorage&&sessionStorage.setItem(t,n),n}catch(t){return console.warn("Failed to generate session id, falling back to ephemeral id:",t),"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}}_ensureMarkup(){if(document.getElementById("chatBubbleContainer"))return;const t=document.createElement("div");t.id="cb-root",t.innerHTML='\n      <div id="chatBubbleContainer" class="chat-bubble">\n        <button id="chatToggle" class="chat-toggle" aria-label="Open chat">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>\n            <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="currentColor"/>\n          </svg>\n        </button>\n        <div id="chatWindow" class="chat-window hidden" role="dialog" aria-label="Chat window">\n          <div class="chat-header">\n            <div class="chat-title">\n              <h3>AI Assistant</h3>\n              <span class="status-indicator online" title="Online"></span>\n            </div>\n            <button id="chatClose" class="chat-close" aria-label="Close">‚úï</button>\n          </div>\n          <div id="chatMessages" class="chat-messages" aria-live="polite"></div>\n          <div class="chat-input-container">\n            <div class="input-wrapper">\n              <input type="text" id="chatInput" class="cb-input" placeholder="Ask a question..." autocomplete="off" />\n              <button id="sendButton" class="send-button" title="Send">\n                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>\n                </svg>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div id="loadingSpinner" class="loading-spinner hidden"><div class="spinner"></div></div>\n    ',document.body.appendChild(t)}_bindElements(){const t=document.getElementById("chatToggle");t&&(this.chatToggle=t);const e=document.getElementById("chatWindow");e&&(this.chatWindow=e);const n=document.getElementById("chatClose");n&&(this.chatClose=n);const s=document.getElementById("chatMessages");s&&(this.chatMessages=s);const a=document.getElementById("chatInput");a&&(this.chatInput=a);const r=document.getElementById("sendButton");r&&(this.sendButton=r);const o=document.getElementById("loadingSpinner");o&&(this.loadingSpinner=o)}_attachListeners(){this.chatToggle&&this.chatToggle.addEventListener("click",()=>this.toggleChat()),this.chatClose&&this.chatClose.addEventListener("click",()=>{this.closeChat()}),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),this.chatInput&&(this.chatInput.addEventListener("input",()=>{this.chatInput.style.height="auto",this.chatInput.style.height=Math.min(this.chatInput.scrollHeight,160)+"px"}),this.chatInput.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendMessage())}))}toggleChat(){this.isOpen=!this.isOpen,this.isOpen?this.openChat():this.closeChat()}openChat(){this.chatWindow&&(this.chatWindow.classList.remove("hidden"),this.chatInput?.focus(),this._scrollToBottomAsync()),this.isOpen=!0}closeChat(){this.chatWindow&&this.chatWindow.classList.add("hidden"),this.isOpen=!1}async sendMessage(){const e=(this.chatInput?.value||"").trim();if(e&&!this.isLoading){this.addMessage("user",this.escapeText(e)),this.chatInput&&(this.chatInput.value="",this.chatInput.style.height="auto"),this.setLoading(!0),this.showTypingIndicator();try{if(this.isProductQuery(e))await this.handleProductQuery(e);else{const n=await t({text:e,sessionId:this.sessionId}),s=await this.sendToLLM(e);this.hideTypingIndicator();const a=n&&n.parsedOutput?n.parsedOutput:null;if(console.debug("webhookData:",n,"parsedOutput:",a),a&&(a.before_message||n&&n.products&&n.products.length||a.after_message)){if(n&&n.products&&n.products.length>0){const t=a.before_message?a.before_message:"I found these products:";console.log("üì¶ Displaying",n.products.length,"products from webhook with header:",t),this.displayProducts(n.products,t,a.after_message)}else if(a.before_message||a.after_message){const t=[a.before_message,a.after_message].filter(Boolean).join("\n\n");this.addMessage("assistant",this.escapeText(t))}}else s?(this.addMessage("assistant",this.escapeText(s)),n&&n.products&&n.products.length>0&&(console.log("üì¶ Displaying",n.products.length,"products from webhook"),this.displayProducts(n.products))):this.addMessage("assistant","Sorry, I didn't get a response. Please try again.")}}catch(t){console.error("‚ùå sendMessage error",t),this.hideTypingIndicator(),this.addMessage("assistant","Sorry ‚Äî something went wrong.")}finally{this.setLoading(!1)}}}async sendToLLM(e){try{const n=await t({text:e,sessionId:this.sessionId});if(!n)return null;let s=null;return n.response?s=n.response:n.reply?s=n.reply:n.message?s=n.message:n.text?s=n.text:n.parsedOutput?"string"==typeof n.parsedOutput?s=n.parsedOutput:n.parsedOutput.before_message?s=n.parsedOutput.before_message:n.parsedOutput.reply?s=n.parsedOutput.reply:n.parsedOutput.response?s=n.parsedOutput.response:n.parsedOutput.output?s=n.parsedOutput.output:n.parsedOutput.message&&(s=n.parsedOutput.message):n.output&&"string"==typeof n.output?s=n.output:n.products&&n.products.length>0&&(s=`Found ${n.products.length} product(s) for you!`),s?(console.log("‚úì Extracted response text:",s.substring(0,100)),s):(console.warn("‚ö†Ô∏è Could not extract response text from webhook data:",n),null)}catch(t){return console.warn("‚ùå sendToLLM webhook error",t),null}}addMessage(t,e){if("assistant"===t){const n=String(e||""),s=/!\[([^\]]*)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,a=/\[([^\]]+)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,r=/https?:\/\/[^\s\"'<>]+\.(png|jpe?g|gif|webp|svg)(\?.*)?/gi,o=/\[\s*(?:Image|image)\s*:\s*(https?:\/\/[^\]\s]+)\s*\]/gi,i=/https?:\/\/cdn\.shopify\.com\/[^\s"'<>\)]+/gi;let d=n.replace(s,(t,e,n)=>`<img src="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="${this.escapeText(e||"image")}" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`).replace(a,(t,e,n)=>`<a href="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" target="_blank" rel="noopener noreferrer">${this.escapeText(e)}</a>`).replace(r,t=>`<img src="${String(t).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`);if(d=d.replace(o,(t,e)=>`<img src="${String(e).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`),d=d.replace(i,t=>`<img src="${String(t).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`),n)return console.debug("Converted assistant message to HTML (image/link detected):",d),void this.addHtmlMessage(t,d);try{const t=/https?:\/\/cdn\.shopify\.com\//i.test(n),e=/\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(n.trim());console.debug("No conversion performed for assistant message. hasCdn:",t,"hasImgExtAtEnd:",e,"preview:",n.substring(0,200))}catch(t){}}const n=document.createElement("div");n.className=`message ${t}`;const s=document.createElement("div");s.className="message-content",s.textContent=e;const a=document.createElement("div");a.className="message-time",a.textContent=this._getCurrentTime(),n.appendChild(s),n.appendChild(a),this.chatMessages&&(this.chatMessages.appendChild(n),this._scrollToBottomAsync())}addHtmlMessage(t,e){const n=document.createElement("div");n.className=`message ${t}`;const s=document.createElement("div");s.className="message-content",s.innerHTML=e;const a=document.createElement("div");a.className="message-time",a.textContent=this._getCurrentTime(),n.appendChild(s),n.appendChild(a),this.chatMessages&&(this.chatMessages.appendChild(n),this._scrollToBottomAsync())}showTypingIndicator(){if(!this.chatMessages)return;if(this.chatMessages.querySelector(".typing-message"))return;const t=document.createElement("div");t.className="message assistant typing-message",t.innerHTML='\n      <div class="message-content typing-indicator">\n        <span></span><span></span><span></span>\n      </div>\n    ',this.chatMessages.appendChild(t),this._scrollToBottomAsync()}hideTypingIndicator(){if(!this.chatMessages)return;const t=this.chatMessages.querySelector(".typing-message");t&&t.remove()}_getCurrentTime(){return(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}_scrollToBottomAsync(){setTimeout(()=>{this.chatMessages&&(this.chatMessages.scrollTop=this.chatMessages.scrollHeight)},80)}setLoading(t){this.isLoading=!!t,this.sendButton&&(this.sendButton.disabled=!!t),this.chatInput&&(this.chatInput.disabled=!!t),this.loadingSpinner&&(t?this.loadingSpinner.classList.remove("hidden"):this.loadingSpinner.classList.add("hidden"))}async loadChatHistory(){try{const t=localStorage.getItem(`cb_history_${this.sessionId}`);if(!t)return;(JSON.parse(t)||[]).forEach(t=>{"user"===t.role?this.addMessage("user",t.content):this.addMessage("assistant",t.content)})}catch(t){console.warn("loadChatHistory failed",t)}}async loadStoreDomain(){try{this.storeDomain=window.location.host}catch(t){}}isProductQuery(t){if(!t)return!1;const e=t.toLowerCase();return["find","search","show","product","items","catalog","shoes","shirt","shirts","dress","pants","buy","price","size","color","under","below","less"].some(t=>e.includes(t))}async handleProductQuery(e){try{try{const n=await t({text:e,sessionId:this.sessionId}),s=n&&n.parsedOutput?n.parsedOutput:null;if(s&&(s.before_message||s.after_message||n.products&&n.products.length)){if(n&&n.products&&n.products.length>0)this.displayProducts(n.products,s.before_message||"I found these products:",s.after_message);else if(s.before_message||s.after_message){const t=[s.before_message,s.after_message].filter(Boolean).join("\n\n");this.addMessage("assistant",this.escapeText(t))}return void this.hideTypingIndicator()}}catch(t){console.debug("webhook structured product attempt failed",t&&t.message?t.message:t)}const n=await this.searchProductsSemantic(e);let s=n&&n.length?n:[];if(!s.length){const t=await this.searchProductsLLM(e);s=t&&t.length?t:s}if(!s.length){const t=await this.searchProductsDirect(e);s=t&&t.length?t:s}if(this.hideTypingIndicator(),!s||0===s.length)return void this.addMessage("assistant","I could not find matching products. Try different keywords.");this.displayProducts(s.slice(0,8),"I found these products:")}catch(t){console.error("handleProductQuery error",t),this.hideTypingIndicator(),this.addMessage("assistant","There was an error fetching products.")}}async searchProductsSemantic(e){try{const n=await t({text:e});return n?Array.isArray(n.products)&&n.products.length?n.products:Array.isArray(n.results)&&n.results.length?n.results:Array.isArray(n)?n:[]:[]}catch(t){return console.warn("searchProductsSemantic webhook failed",t),[]}}async searchProductsLLM(e){try{const n=await t({text:e});return n&&(n.products||n.results)||[]}catch(t){return console.warn("searchProductsLLM webhook failed",t),[]}}async searchProductsDirect(e){try{const n=await t({text:e});return n?Array.isArray(n.products)?n.products:Array.isArray(n.results)?n.results.map(t=>({product_id:t.product_id||t.id||null,title:t.title||t.name||"",handle:t.handle||"",description:t.description||"",tags:Array.isArray(t.tags)?t.tags:[],featuredImage:t.featuredImage&&{url:t.featuredImage.url,altText:t.featuredImage.altText}||(t.image?{url:t.image}:null),variants:t.variants&&Array.isArray(t.variants)?t.variants:[],priceRange:t.priceRange||void 0,_vector_meta:{score:t.score,certainty:t.certainty,raw:t}})):Array.isArray(n)?n:[]:[]}catch(t){return console.warn("searchProductsDirect webhook failed",t),[]}}async getProducts(){try{const t=await fetch(`${this.apiBaseUrl}/api/shopify/products`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Basic dGVzdDpzdW12ZWM="}});if(!t.ok)return[];const e=await t.json();return Array.isArray(e.products)?e.products:(e?.data?.products?.edges||[]).map(t=>t.node||{})}catch(t){return console.warn("getProducts failed",t),[]}}displayProducts(t=[],e="I found these products:",s=null){if(!t||!t.length)return;const a=t.slice(0,8).map(t=>{const e=t.title||t.name||t.handle||t.product_id||"Untitled",s=this.escapeText(e),a=t.handle||"",r=t.variants&&t.variants[0]&&t.variants[0].price||t.priceRange&&t.priceRange.minVariantPrice&&t.priceRange.minVariantPrice.amount||"",o=t.variants&&t.variants[0]&&t.variants[0].currency||t.priceRange&&t.priceRange.minVariantPrice&&t.priceRange.minVariantPrice.currencyCode||"",i=function(t){if(!t)return null;const e=[];if("string"==typeof t&&e.push(t),t.featuredImage&&("string"==typeof t.featuredImage?e.push(t.featuredImage):t.featuredImage.url&&e.push(t.featuredImage.url)),t.featured_image&&e.push(t.featured_image),t.image&&e.push(t.image),t.featuredImageUrl&&e.push(t.featuredImageUrl),t.featured_image_url&&e.push(t.featured_image_url),t.url&&e.push(t.url),t.images&&Array.isArray(t.images)&&t.images.length){const n=t.images[0];n&&"string"==typeof n&&e.push(n),n&&n.src&&e.push(n.src)}t.image&&"object"==typeof t.image&&t.image.src&&e.push(t.image.src);for(const t of e){const e=n(t);if(e)return e}return null}(t)||t.image&&("string"==typeof t.image?t.image:t.image.url||null)||t.featuredImage&&("string"==typeof t.featuredImage?t.featuredImage:t.featuredImage.url||null)||"",d=this.buildProductUrl(a),c=t?.id;return`\n          <div class="cb-product">\n              ${i?`<img src="${i}" alt="${s}" \n               style="width:72px;height:72px;object-fit:cover;\n               border-radius:6px;margin-right:8px">`:""}\n              <div style="flex:1">\n                <div style="font-weight:600">${s}${r?` - ${o} ${r}`:""}</div>\n                <div style="margin-top:6px">\n                  <a href="${d}" target="_blank" \n                     rel="noopener noreferrer" \n                     style="color:var(--cb-primary,#667eea);\n                     text-decoration:none;margin-right:8px">View</a>\n                  ${c?`<button class="cb-add" data-variant="${c}" \n               style="color:var(--cb-primary,#667eea);\n               text-decoration:none;font-size:13px;\n               background:#f0f4ff;padding:2px 6px;border-radius:4px;\n               display:inline-block;transition:all 0.2s;border:none;cursor:pointer;">\n               Add to Cart</button>`:""}\n                </div>\n              </div>\n            </div>\n        `}).join("");let r=`<div style="font-weight:600;margin-bottom:6px">${this.escapeText(e)}</div>`+a;s&&(r+=`<div style="margin-top:8px;color:#6b7280;font-size:13px">${this._convertInlineMedia(s)}</div>`),this.addHtmlMessage("assistant",r),setTimeout(()=>{Array.from(this.chatMessages.querySelectorAll(".cb-add")).forEach(t=>{t.onclick=async t=>{const e=t.currentTarget,n=e.getAttribute("data-variant");n?await this.onAddToCartClicked(n,1,e)?this.addMessage("assistant","Added to cart!"):this.addMessage("assistant","Failed to add to cart."):this.addMessage("assistant","This product cannot be added automatically.")}})},200)}async addVariantToCart(t,e=1){try{let n=t;if("string"==typeof t&&t.includes("/")){const e=t.split("/");n=e[e.length-1]}const s=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n,quantity:e})});if(!s.ok){const t=await s.text().catch(()=>"");return console.warn("cart add error",s.status,t),!1}return!0}catch(t){return console.warn("addVariantToCart failed",t),!1}}async onAddToCartClicked(e,n=1,s=null){let a=null;try{if(console.log("onAddToCartClicked called with variant:",e,"quantity:",n,"button:",s),this.setLoading(!0),s&&"string"!=typeof s)try{s.disabled=!0,a=s.innerHTML,s.innerHTML="Adding..."}catch(t){}let r=e;if("string"==typeof e&&e.includes("/")){const t=e.split("/");r=t[t.length-1]}try{const e={text:`add ${r} to my cart`,sessionId:this.sessionId};console.log("Posting add-to-cart intent to webhook:",e.text);const n=await t(e);console.log("Webhook add-to-cart response:",n);let s=null;if(n&&(n.parsedOutput&&"object"==typeof n.parsedOutput&&(s=n.parsedOutput.before_message||n.parsedOutput.output||n.parsedOutput.message||null),s||"string"!=typeof n.output||(s=n.output),!s&&n.response&&(s=n.response)),s){const t=String(s),e=t.match(/<href>(.*?)<\/href>/i);if(e&&e[1]){const n=`<a href="${e[1].trim()}" target="_blank" rel="noopener noreferrer">Proceed to Checkout</a>`,s=/!\[([^\]]*)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,a=t.replace(/<href>(.*?)<\/href>/gi,n).replace(s,(t,e,n)=>`<img src="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="${this.escapeText(e||"image")}" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0; box-sizing: content-box;">`);this.addHtmlMessage("assistant",a)}else if(/<a\s+href=|<button|<img|<div|<span/.test(t.toLowerCase())){const e=/!\[([^\]]*)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,n=t.replace(e,(t,e,n)=>`<img src="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="${this.escapeText(e||"image")}" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0; box-sizing: content-box;">`);this.addHtmlMessage("assistant",n)}else{const e=/!\[([^\]]*)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,n=/\[([^\]]+)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,s=/\[\s*(?:Image|image)\s*:\s*(https?:\/\/[^\]\s]+)\s*\]/gi;let a=t.replace(e,(t,e,n)=>`<img src="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="${this.escapeText(e||"image")}" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`).replace(n,(t,e,n)=>`<a href="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" target="_blank" rel="noopener noreferrer">${this.escapeText(e)}</a>`);if(a=a.replace(s,(t,e)=>`<img src="${String(e).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`),a=a.replace(/https?:\/\/[^\s"'<>]+\.(png|jpe?g|gif|webp|svg)(\?.*)?/gi,t=>`<img src="${String(t).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`),a!==t)console.debug("Converted webhook add-to-cart message to HTML:",a),this.addHtmlMessage("assistant",a);else{try{const e=/https?:\/\/cdn\.shopify\.com\//i.test(t);console.debug("Webhook add-to-cart: no replacement performed. hasCdn:",e,"preview:",t.substring(0,200))}catch(t){}const e=t.match(/https?:\/\/[^\s"'<>\)]+/i);if(e){let n=e[0];const s=n.replace(/^[\("'\s]+|[\)"'\s]+$/g,"");if(/\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(s)){const e=`<img src="${s}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`,a=t.replace(n,e);this.addHtmlMessage("assistant",a)}else{const e=`<a href="${s}" target="_blank" rel="noopener noreferrer">${s}</a>`,a=t.replace(n,e);this.addHtmlMessage("assistant",a)}}else this.addMessage("assistant",t)}}return!0}}catch(t){console.warn("Webhook add-to-cart call failed:",t)}const o=await this.addVariantToCart(r,n);return console.log("addVariantToCart result for",r,":",o),o}catch(t){return console.warn("onAddToCartClicked error",t),!1}finally{try{s&&"string"!=typeof s&&(s.disabled=!1,null!==a&&(s.innerHTML=a))}catch(t){}this.setLoading(!1)}}buildProductUrl(t){if(!t)return"#";const e=this.storeDomain||window.location.host;return`${(e.startsWith("http://")||e.startsWith("https://")?e:`https://${e}`).replace(/\/+$/,"")}/products/${encodeURIComponent(t)}`}escapeText(t){return(t||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"'"}[t]))}_convertInlineMedia(t){const e=String(t||""),n=this._reconstructShopifyCdnUrls(e);let s=n.replace(/!\[([^\]]*)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,(t,e,n)=>`<img src="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="${this.escapeText(e||"image")}" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`).replace(/\[([^\]]+)\]\s*\(\s*(https?:\/\/[^\s)]+)\s*\)/gi,(t,e,n)=>`<a href="${String(n).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" target="_blank" rel="noopener noreferrer">${this.escapeText(e)}</a>`).replace(/https?:\/\/[^\s\"'<>]+\.(png|jpe?g|gif|webp|svg)(\?.*)?/gi,t=>`<img src="${String(t).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`);return s=s.replace(/\[\s*(?:Image|image)\s*:\s*(https?:\/\/[^\]\s]+)\s*\]/gi,(t,e)=>`<img src="${String(e).replace(/^[\("'\s]+|[\)"'\s]+$/g,"")}" alt="product image" style="max-width:100%;height:auto;border-radius:8px;display:block;margin:8px 0;">`),s===n?this.escapeText(n):s}_reconstructShopifyCdnUrls(t){return t?String(t).replace(/https?:\/\/cdn\.shopify\.com[\s\S]{0,1000}/gi,t=>{const e=t.match(/(https?:\/\/cdn\.shopify\.com[\s\S]*?(?:png|jpe?g|gif|webp|svg)(?:\?[^\s\)]*)?)/i);return e&&e[1]?e[1].replace(/\s+/g,""):t}):t}unmount(){const t=document.getElementById("cb-root");t&&t.parentNode&&t.parentNode.removeChild(t),this.chatToggle=null,this.chatWindow=null,this.chatClose=null,this.chatMessages=null,this.chatInput=null,this.sendButton=null,this.loadingSpinner=null}}function n(t){if(!t)return null;try{let e=String(t).trim();try{btn&&"string"!=typeof btn&&(btn.disabled=!1,null!==prevHtml&&(btn.innerHTML=prevHtml))}catch(t){}return this.setLoading(!1),e.startsWith("//")&&(e=window.location.protocol+e),"https:"===window.location.protocol&&e.startsWith("http:")&&(e="https:"+e.slice(5)),e}catch(t){return null}}function s(){window.chatBubble=window.chatBubble||new e}document.addEventListener("DOMContentLoaded",s),window.chatBubbleInitHandler=s,window.unmountChatBubble=function(){window.chatBubble&&"function"==typeof window.chatBubble.unmount&&(window.chatBubble.unmount(),window.chatBubble=null),window.chatBubbleInitHandler&&(document.removeEventListener("DOMContentLoaded",window.chatBubbleInitHandler),window.chatBubbleInitHandler=null)},window.ChatBubble=e})();